name: myPlanet build

on:
  push:
    branches:
      - '*'
      - '!master'
      - 'claude/**'
      - 'codex/**'
      - 'dependabot/**'
      - 'jules/**'
      - '*-codex/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build:
    name: myPlanet build
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        build: [default, lite]
    steps:
      - name: checkout repository code
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: check and diff the code to get lite
        if: matrix.build == 'lite'
        run: |
          file="app/src/main/AndroidManifest.xml"
          lite="app/src/lite/AndroidManifest.xml"
          ls -al "$file" "$lite"
          diff <(sed 's/^\s*<!--//; s/-->\s*$//' "$file") <(sed 's/^\s*<!--//; s/-->\s*$//' "$lite")
          cp "$lite" "$file"

      - name: setup gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          gradle-version: wrapper
          cache-disabled: false
          cache-read-only: false
          cache-write-only: false

      - name: build debug as test
        run: |
          FLAVOR=${{ matrix.build }}
          ./gradlew assemble${FLAVOR^}Debug --warning-mode all --stacktrace --parallel --max-workers=4

      - name: fetch metrics
        uses: actions/checkout@v4
        with:
          ref: metrics
          path: .metrics
        continue-on-error: true

      - name: measure apk size
        id: measure
        run: |
          FLAVOR=${{ matrix.build }}
          APK_PATH="app/build/outputs/apk/${FLAVOR}/debug/app-${FLAVOR}-debug.apk"
          python3 scripts/measure_size.py \
            --file "$APK_PATH" \
            --flavor "$FLAVOR" \
            --build-type debug \
            --config scripts/size_limits.json \
            --metrics-db ".metrics/data.json" \
            --output-json "size-report-${FLAVOR}.json" \
            --output-md "size-report-${FLAVOR}.md"

      - name: upload size report
        uses: actions/upload-artifact@v4
        with:
          name: size-report-${{ matrix.build }}
          path: size-report-${{ matrix.build }}.*

  report-size:
    name: Report Size
    needs: build
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: download size reports
        uses: actions/download-artifact@v4
        with:
          pattern: size-report-*
          merge-multiple: true

      - name: combine reports and comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let commentBody = '## ðŸ“Š APK Size Report\n\n';
            const files = fs.readdirSync('.').filter(fn => fn.endsWith('.md') && fn.startsWith('size-report-'));

            if (files.length === 0) {
              console.log('No size reports found.');
              return;
            }

            for (const file of files) {
              commentBody += fs.readFileSync(file, 'utf8') + '\n---\n';
            }
            commentBody = commentBody.slice(0, -5);

            if (context.eventName === 'pull_request') {
                await github.rest.issues.createComment({
                    issue_number: context.issue.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: commentBody
                });
            } else if (context.eventName === 'push') {
                const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    commit_sha: context.sha
                });
                if (prs.data.length > 0) {
                     await github.rest.issues.createComment({
                        issue_number: prs.data[0].number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: commentBody
                    });
                }
            }
